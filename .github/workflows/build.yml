name: build-itm

on:
  push:
  release:
    types: [published]

jobs:
  build-linux:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [x86_64, i686, aarch64]
    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build
        run: |
          docker run --rm \
            -v $PWD:/src \
            -w /src \
            quay.io/pypa/manylinux2014_${{ matrix.arch }} \
            bash -c "
              make clean &&
              make
            "

      - name: Test
        run: |
          docker run --rm \
            -v $PWD:/src \
            -w /src \
            quay.io/pypa/manylinux2014_${{ matrix.arch }} \
            bash -c "
              g++ -o test_libitm test/test_libitm.c -ldl &&
              ./test_libitm
            "
            
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: itm-linux-${{ matrix.arch }}
          path: bin/libitm.so

      - name: Create archive
        run: |
          cd bin
          tar czf ../itm-linux-${{ matrix.arch }}.tar.gz libitm.so
          cd ..

      - name: Upload Release Assets
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: ./itm-linux-*.tar.gz

  build-macos:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: macos-15
            arch: x86_64
          - os: macos-15
            arch: arm64
          - os: macos-14
            arch: x86_64
          - os: macos-14
            arch: arm64
    steps:
      - uses: actions/checkout@v4

      - name: Build
        run: |
          make clean
          make

      - name: Test
        run: |
          g++ -o test_libitm test/test_libitm.c
          ./test_libitm

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: itm-macos-${{ matrix.os }}-${{ matrix.arch }}
          path: bin/libitm.*

      - name: Create archive
        run: |
          cd bin
          tar czf ../itm-macos-${{ matrix.os }}-${{ matrix.arch }}.tar.gz libitm.*
          cd ..

      - name: Upload Release Assets
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: ./itm-macos-*.tar.gz

  build-windows:
    runs-on: windows-latest
    strategy:
      matrix:
        platform: [x64, x86]
        configuration: [Release]
    steps:
      - uses: actions/checkout@v4

      - name: Add MSBuild to PATH
        uses: microsoft/setup-msbuild@v2

      - name: Build
        run: |
          msbuild win32\itm.sln /p:Configuration=${{ matrix.configuration }} /p:Platform=${{ matrix.platform }} /m

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: itm-windows-${{ matrix.platform }}
          path: |
            bin/${{ matrix.platform }}/${{ matrix.configuration }}/itm.dll
            bin/${{ matrix.platform }}/${{ matrix.configuration }}/ITMDrvr.exe

      - name: Create archive
        run: |
          Compress-Archive -Path bin\${{ matrix.platform }}\${{ matrix.configuration }}\itm.dll, bin\${{ matrix.platform }}\${{ matrix.configuration }}\ITMDrvr.exe -DestinationPath itm-windows-${{ matrix.platform }}.zip

      - name: Upload Release Assets
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: ./itm-windows-*.zip

  build-wasm:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Emscripten
        uses: mymindstorm/setup-emsdk@v14
        with:
          version: '3.1.51'
          actions-cache-folder: 'emsdk-cache'

      - name: Verify Emscripten installation
        run: |
          emcc --version
          em++ --version

      - name: Create output directory
        run: mkdir -p dist

      - name: Build WebAssembly with Emscripten
        run: |
          em++ -O3 \
            src/itm_em_wrapper.cpp \
            src/itm_p2p.cpp \
            src/itm_area.cpp \
            src/ValidateInputs.cpp \
            src/ComputeDeltaH.cpp \
            src/DiffractionLoss.cpp \
            src/FindHorizons.cpp \
            src/FreeSpaceLoss.cpp \
            src/FresnelIntegral.cpp \
            src/H0Function.cpp \
            src/InitializeArea.cpp \
            src/InitializePointToPoint.cpp \
            src/InverseComplementaryCumulativeDistributionFunction.cpp \
            src/KnifeEdgeDiffraction.cpp \
            src/LinearLeastSquaresFit.cpp \
            src/LineOfSightLoss.cpp \
            src/LongleyRice.cpp \
            src/QuickPfl.cpp \
            src/SigmaHFunction.cpp \
            src/SmoothEarthDiffraction.cpp \
            src/TerrainRoughness.cpp \
            src/TroposcatterLoss.cpp \
            src/Variability.cpp \
            -std=c++17 -lembind \
            -sMODULARIZE=1 -sEXPORT_NAME=ITM \
            -sENVIRONMENT=web,worker,node \
            -sALLOW_MEMORY_GROWTH=1 \
            -o dist/itm.js

      - name: Verify build output
        run: |
          echo "Build artifacts:"
          ls -lh dist/
          echo ""
          echo "WASM file size:"
          du -h dist/itm.wasm
          echo ""
          echo "JS file size:"
          du -h dist/itm.js

      - name: Create HTML demo
        run: |
          cat > dist/demo.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>ITM WebAssembly Demo</title>
              <style>
                  body { 
                      font-family: 'Segoe UI', Arial, sans-serif; 
                      max-width: 900px; 
                      margin: 50px auto; 
                      padding: 20px;
                      background: #f5f5f5;
                  }
                  .container {
                      background: white;
                      padding: 30px;
                      border-radius: 10px;
                      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                  }
                  h1 { color: #333; margin-top: 0; }
                  .input-group { 
                      margin: 15px 0; 
                      display: flex; 
                      align-items: center; 
                  }
                  label { 
                      display: inline-block; 
                      width: 200px; 
                      font-weight: 500;
                  }
                  input, select { 
                      flex: 1;
                      padding: 8px 12px; 
                      border: 1px solid #ddd;
                      border-radius: 4px;
                      font-size: 14px;
                  }
                  button { 
                      margin-top: 20px; 
                      padding: 12px 30px; 
                      background: #0066cc; 
                      color: white; 
                      border: none; 
                      border-radius: 5px;
                      cursor: pointer;
                      font-size: 16px;
                      font-weight: 500;
                  }
                  button:hover { background: #0052a3; }
                  button:disabled { background: #ccc; cursor: not-allowed; }
                  #result { 
                      margin-top: 30px; 
                      padding: 20px; 
                      background: #f8f9fa; 
                      border-radius: 5px;
                      border-left: 4px solid #0066cc;
                  }
                  .status { 
                      padding: 10px; 
                      margin: 15px 0; 
                      border-radius: 4px; 
                  }
                  .status.loading { background: #fff3cd; color: #856404; }
                  .status.success { background: #d4edda; color: #155724; }
                  .status.error { background: #f8d7da; color: #721c24; }
                  pre { 
                      background: #f4f4f4; 
                      padding: 10px; 
                      border-radius: 4px; 
                      overflow-x: auto; 
                  }
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>üåê ITM WebAssembly Demo</h1>
                  <p>Irregular Terrain Model - Radio Wave Propagation Calculator</p>
                  
                  <div id="status" class="status loading">
                      Loading ITM module...
                  </div>
                  
                  <div id="calculator" style="display: none;">
                      <h3>Area Prediction Mode</h3>
                      
                      <div class="input-group">
                          <label>TX Height (meters):</label>
                          <input type="number" id="h_tx" value="30" min="0.5" max="3000">
                      </div>
                      
                      <div class="input-group">
                          <label>RX Height (meters):</label>
                          <input type="number" id="h_rx" value="3" min="0.5" max="3000">
                      </div>
                      
                      <div class="input-group">
                          <label>Distance (km):</label>
                          <input type="number" id="distance" value="50" min="1">
                      </div>
                      
                      <div class="input-group">
                          <label>Frequency (MHz):</label>
                          <input type="number" id="frequency" value="1000" min="20" max="20000">
                      </div>
                      
                      <div class="input-group">
                          <label>Climate:</label>
                          <select id="climate">
                              <option value="1">Equatorial</option>
                              <option value="2">Continental Subtropical</option>
                              <option value="3">Maritime Subtropical</option>
                              <option value="4">Desert</option>
                              <option value="5" selected>Continental Temperate</option>
                              <option value="6">Maritime Temperate Over Land</option>
                              <option value="7">Maritime Temperate Over Sea</option>
                          </select>
                      </div>
                      
                      <div class="input-group">
                          <label>Polarization:</label>
                          <select id="pol">
                              <option value="0">Horizontal</option>
                              <option value="1" selected>Vertical</option>
                          </select>
                      </div>
                      
                      <div class="input-group">
                          <label>Surface Refractivity:</label>
                          <input type="number" id="N_0" value="301" min="250" max="400">
                      </div>
                      
                      <div class="input-group">
                          <label>Terrain Irregularity (m):</label>
                          <input type="number" id="delta_h" value="90" min="0">
                      </div>
                      
                      <button id="calcBtn" onclick="calculate()">Calculate Propagation Loss</button>
                      
                      <div id="result" style="display: none;"></div>
                  </div>
              </div>
              
              <script type="module">
                  import ITM from './itm.js';
                  
                  let itmModule = null;
                  const statusDiv = document.getElementById('status');
                  const calculatorDiv = document.getElementById('calculator');
                  
                  // Initialize the module
                  (async () => {
                      try {
                          itmModule = await ITM();
                          
                          statusDiv.className = 'status success';
                          statusDiv.innerHTML = '‚úì ITM Module loaded successfully! Ready to calculate.';
                          calculatorDiv.style.display = 'block';
                          
                          console.log('ITM Module loaded:', itmModule);
                      } catch (error) {
                          statusDiv.className = 'status error';
                          statusDiv.innerHTML = '‚úó Failed to load module: ' + error.message;
                          console.error('Load error:', error);
                      }
                  })();
                  
                  // Make calculate function global
                  window.calculate = async function() {
                      if (!itmModule) {
                          alert('Module not loaded yet. Please wait...');
                          return;
                      }
                      
                      const resultDiv = document.getElementById('result');
                      
                      try {
                          // Get input values
                          const h_tx = parseFloat(document.getElementById('h_tx').value);
                          const h_rx = parseFloat(document.getElementById('h_rx').value);
                          const d_km = parseFloat(document.getElementById('distance').value);
                          const f_mhz = parseFloat(document.getElementById('frequency').value);
                          const climate = parseInt(document.getElementById('climate').value);
                          const pol = parseInt(document.getElementById('pol').value);
                          const N_0 = parseFloat(document.getElementById('N_0').value);
                          const delta_h = parseFloat(document.getElementById('delta_h').value);
                          
                          // Area mode parameters
                          const epsilon = 15.0;  // Relative permittivity
                          const sigma = 0.005;   // Conductivity
                          const mdvar = 3;       // Broadcast mode
                          const time = 50;       // Time variability (%)
                          const location = 50;   // Location variability (%)
                          const situation = 50;  // Situation variability (%)
                          
                          // Call ITM area mode
                          console.log('Calling ITM with parameters:', {
                              h_tx, h_rx, d_km, f_mhz, climate, pol, N_0, delta_h
                          });
                          
                          const result = itmModule.ITM_AREA_TLS(
                              h_tx, h_rx,
                              0, 0,  // siting criteria (random)
                              d_km,
                              delta_h,
                              climate,
                              N_0,
                              f_mhz,
                              pol,
                              epsilon,
                              sigma,
                              mdvar,
                              time,
                              location,
                              situation
                          );
                          
                          console.log('ITM Result:', result);
                          
                          resultDiv.style.display = 'block';
                          resultDiv.innerHTML = `
                              <h3>üìä Propagation Results</h3>
                              <p><strong>Basic Transmission Loss:</strong> 
                                  <span style="font-size: 1.5em; color: #0066cc;">${result.A__db.toFixed(2)} dB</span>
                              </p>
                              <p><strong>Free Space Loss:</strong> ${result.A_fs__db.toFixed(2)} dB</p>
                              <p><strong>Mode of Propagation:</strong> ${getModeDescription(result.mode)}</p>
                              <p><strong>Warning Flags:</strong> ${result.warnings === 0 ? '‚úì None' : '‚ö† ' + result.warnings.toString(16)}</p>
                              
                              <h4>Input Parameters:</h4>
                              <pre>TX Height: ${h_tx} m
          RX Height: ${h_rx} m
          Distance: ${d_km} km
          Frequency: ${f_mhz} MHz
          Climate: ${getClimateDescription(climate)}
          Polarization: ${pol === 0 ? 'Horizontal' : 'Vertical'}
          Surface Refractivity: ${N_0} N-Units
          Terrain Irregularity: ${delta_h} m</pre>
                              
                              <p style="margin-top: 15px; font-size: 0.9em; color: #666;">
                                  <em>The ITM predicts radio wave propagation loss based on terrain, atmospheric conditions, and system parameters.</em>
                              </p>
                          `;
                      } catch (error) {
                          resultDiv.style.display = 'block';
                          resultDiv.innerHTML = `<p style="color: red;"><strong>Error:</strong> ${error.message}</p>`;
                          console.error('Calculation error:', error);
                      }
                  };
                  
                  function getModeDescription(mode) {
                      const modes = {
                          1: 'Line of Sight',
                          2: 'Diffraction',
                          3: 'Troposcatter'
                      };
                      return modes[mode] || 'Unknown';
                  }
                  
                  function getClimateDescription(climate) {
                      const climates = {
                          1: 'Equatorial',
                          2: 'Continental Subtropical',
                          3: 'Maritime Subtropical',
                          4: 'Desert',
                          5: 'Continental Temperate',
                          6: 'Maritime Temperate Over Land',
                          7: 'Maritime Temperate Over Sea'
                      };
                      return climates[climate] || 'Unknown';
                  }
              </script>
          </body>
          </html>
          EOF

      - name: Create Node.js test script
        run: |
          cat > dist/test-node.mjs << 'EOF'
          /**
           * Node.js test script for ITM WebAssembly module
           */
          import ITM from './itm.js';
          
          (async () => {
              console.log('üîÑ Loading ITM WebAssembly module...\n');
              
              try {
                  const itm = await ITM();
                  console.log('‚úì Module loaded successfully!\n');
                  
                  // Test Area Mode
                  console.log('=== Testing ITM Area Mode ===\n');
                  
                  const result = itm.ITM_AREA_TLS(
                      30,    // h_tx__meter (TX height)
                      3,     // h_rx__meter (RX height)
                      0,     // tx_site_criteria (random)
                      0,     // rx_site_criteria (random)
                      50,    // d__km (distance)
                      90,    // delta_h__meter (terrain irregularity)
                      5,     // climate (Continental Temperate)
                      301,   // N_0 (surface refractivity)
                      1000,  // f__mhz (frequency)
                      1,     // pol (vertical)
                      15,    // epsilon (relative permittivity)
                      0.005, // sigma (conductivity)
                      3,     // mdvar (broadcast mode)
                      50,    // time (%)
                      50,    // location (%)
                      50     // situation (%)
                  );
                  
                  console.log('Test Case: 50km link at 1000 MHz');
                  console.log('‚îÄ'.repeat(50));
                  console.log(`TX Height:              30 m`);
                  console.log(`RX Height:              3 m`);
                  console.log(`Distance:               50 km`);
                  console.log(`Frequency:              1000 MHz`);
                  console.log(`Climate:                Continental Temperate`);
                  console.log(`Terrain Irregularity:   90 m`);
                  console.log('');
                  console.log('Results:');
                  console.log(`  Basic Transmission Loss:  ${result.A__db.toFixed(2)} dB`);
                  console.log(`  Free Space Loss:          ${result.A_fs__db.toFixed(2)} dB`);
                  console.log(`  Mode of Propagation:      ${getModeString(result.mode)}`);
                  console.log(`  Warnings:                 ${result.warnings === 0 ? 'None' : '0x' + result.warnings.toString(16)}`);
                  console.log('');
                  
                  // Additional test cases
                  console.log('=== Additional Test Cases ===\n');
                  
                  const testCases = [
                      { d: 10, f: 100, desc: 'Short range, low frequency' },
                      { d: 100, f: 5000, desc: 'Long range, high frequency' },
                      { d: 25, f: 2400, desc: 'WiFi frequency (2.4 GHz)' }
                  ];
                  
                  testCases.forEach((test, index) => {
                      const res = itm.ITM_AREA_TLS(
                          30, 3, 0, 0, test.d, 90, 5, 301, test.f, 1, 15, 0.005, 3, 50, 50, 50
                      );
                      console.log(`Test ${index + 1}: ${test.desc}`);
                      console.log(`  Distance: ${test.d} km, Frequency: ${test.f} MHz`);
                      console.log(`  Loss: ${res.A__db.toFixed(2)} dB (Mode: ${getModeString(res.mode)})`);
                      console.log('');
                  });
                  
                  console.log('‚úì All tests completed successfully!\n');
                  
              } catch (error) {
                  console.error('‚úó Test failed:', error);
                  process.exit(1);
              }
              
              function getModeString(mode) {
                  const modes = { 1: 'Line of Sight', 2: 'Diffraction', 3: 'Troposcatter' };
                  return modes[mode] || 'Unknown';
              }
          })();
          EOF

      - name: Test WebAssembly build with Node.js
        run: |
          cd dist
          node test-node.mjs

      - name: Create package.json
        run: |
          cat > dist/package.json << 'EOF'
          {
            "name": "itm-wasm",
            "version": "1.4.0",
            "description": "ITM (Irregular Terrain Model) compiled to WebAssembly with Embind",
            "type": "module",
            "main": "itm.js",
            "files": [
              "itm.js",
              "itm.wasm",
              "README.md"
            ],
            "keywords": [
              "itm",
              "irregular-terrain-model",
              "longley-rice",
              "radio-propagation",
              "rf-propagation",
              "webassembly",
              "wasm",
              "embind"
            ],
            "author": "ITS/NTIA",
            "license": "SEE LICENSE IN ../LICENSE"
          }
          EOF

      - name: Create README for WebAssembly
        run: |
          cat > dist/README.md << 'EOF'
          # ITM WebAssembly Build
          
          This is the ITM (Irregular Terrain Model) library compiled to WebAssembly using Emscripten with Embind bindings.
          
          ## Files
          
          - `itm.js` - Emscripten-generated JavaScript loader with Embind bindings
          - `itm.wasm` - Compiled WebAssembly binary
          - `demo.html` - Interactive browser demo
          - `test-node.mjs` - Node.js test script
          - `package.json` - npm package configuration
          
          ## Quick Start
          
          ### Browser Usage
          
          ```html
          <script type="module">
            import ITM from './itm.js';
            
            const itm = await ITM();
            
            // Calculate area mode propagation loss
            const result = itm.ITM_AREA_TLS(
              30,    // TX height (m)
              3,     // RX height (m)
              0, 0,  // siting criteria
              50,    // distance (km)
              90,    // terrain irregularity (m)
              5,     // climate
              301,   // surface refractivity
              1000,  // frequency (MHz)
              1,     // polarization (vertical)
              15,    // epsilon
              0.005, // sigma
              3,     // mode variability
              50, 50, 50  // time, location, situation (%)
            );
            
            console.log('Loss:', result.A__db, 'dB');
          </script>
          ```
          
          ### Node.js Usage
          
          ```javascript
          import ITM from './itm.js';
          
          const itm = await ITM();
          
          const result = itm.ITM_AREA_TLS(
            30, 3, 0, 0, 50, 90, 5, 301, 1000, 1, 15, 0.005, 3, 50, 50, 50
          );
          
          console.log('Basic Transmission Loss:', result.A__db, 'dB');
          console.log('Free Space Loss:', result.A_fs__db, 'dB');
          console.log('Mode:', result.mode); // 1=LoS, 2=Diffraction, 3=Troposcatter
          ```
          
          ## Available Functions
          
          The module exposes the following ITM functions through Embind:
          
          ### Area Prediction Mode
          
          - **`ITM_AREA_TLS(...)`** - Area mode with time/location/situation variability
          - **`ITM_AREA_CR(...)`** - Area mode with confidence/reliability
          
          ### Point-to-Point Mode
          
          - **`ITM_P2P_TLS(...)`** - Point-to-point with time/location/situation
          - **`ITM_P2P_CR(...)`** - Point-to-point with confidence/reliability
          
          ### Return Values
          
          All main functions return an object with:
          - `A__db` - Basic transmission loss (dB)
          - `A_fs__db` - Free space loss (dB) 
          - `d__km` - Path distance (km)
          - `theta_hzn` - Horizon angles (array)
          - `d_hzn__meter` - Horizon distances (array)
          - `h_e__meter` - Effective heights (array)
          - `delta_h__meter` - Terrain irregularity (m)
          - `N_s` - Surface refractivity
          - `A_ref__db` - Reference attenuation (dB)
          - `mode` - Propagation mode (1=LoS, 2=Diffraction, 3=Troposcatter)
          - `warnings` - Warning flags
          
          ## Interactive Demo
          
          Open `demo.html` in a web browser (must be served via HTTP/HTTPS):
          
          ```bash
          # Python
          python3 -m http.server 8000
          
          # Node.js
          npx serve .
          
          # Then visit: http://localhost:8000/demo.html
          ```
          
          ## Testing
          
          Run the test suite:
          ```bash
          node test-node.mjs
          ```
          
          Expected output shows propagation loss calculations for various scenarios.
          
          ## Input Parameters
          
          ### Common Parameters (all modes)
          
          - `h_tx__meter` - TX structural height (0.5-3000 m)
          - `h_rx__meter` - RX structural height (0.5-3000 m)
          - `climate` - Radio climate (1-7)
            - 1 = Equatorial
            - 2 = Continental Subtropical
            - 3 = Maritime Subtropical
            - 4 = Desert
            - 5 = Continental Temperate
            - 6 = Maritime Temperate Over Land
            - 7 = Maritime Temperate Over Sea
          - `N_0` - Surface refractivity (250-400 N-Units)
          - `f__mhz` - Frequency (20-20000 MHz)
          - `pol` - Polarization (0=Horizontal, 1=Vertical)
          - `epsilon` - Relative permittivity (>1)
          - `sigma` - Conductivity (>0 S/m)
          - `mdvar` - Mode of variability (0-3, +10 to eliminate location, +20 for situation)
          
          ### Area Mode Specific
          
          - `d__km` - Path distance (km)
          - `delta_h__meter` - Terrain irregularity (m)
          - `tx_siting_criteria` - TX siting (0=Random, 1=Careful, 2=Very Careful)
          - `rx_siting_criteria` - RX siting (0=Random, 1=Careful, 2=Very Careful)
          
          ### Point-to-Point Mode Specific
          
          - `pfl` - Terrain profile array:
            - `[0]` = number of elevation points - 1
            - `[1]` = resolution in meters
            - `[i]` = elevation in meters
          
          ## Performance
          
          - **Binary Size:** ~200-300 KB (uncompressed)
          - **Gzipped:** ~80-120 KB
          - **Load Time:** <200ms on modern connections
          - **Execution:** Near-native C++ performance
          
          ## Browser Compatibility
          
          - ‚úì Chrome 57+
          - ‚úì Firefox 52+
          - ‚úì Safari 11+
          - ‚úì Edge 16+
          
          ## Node.js Compatibility
          
          - Node.js 12+ with ES module support
          - Use `.mjs` extension or `"type": "module"` in package.json
          
          ## Documentation
          
          For complete ITM documentation, see:
          - [Main README](../README.md)
          - [Error Codes & Warnings](../ERRORS_AND_WARNINGS.md)
          - [Command-line Tool](../cmdREADME.md)
          
          ## License
          
          See the main repository LICENSE file.
          
          EOF

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: itm-wasm
          path: |
            dist/itm.js
            dist/itm.wasm
            dist/demo.html
            dist/test-node.mjs
            dist/package.json
            dist/README.md

      - name: Create release archive
        run: |
          cd dist
          tar czf ../itm-wasm.tar.gz itm.js itm.wasm demo.html test-node.mjs package.json README.md
          cd ..

      - name: Upload Release Assets
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: ./itm-wasm.tar.gz
